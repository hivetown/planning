@startuml "System Architecture"

actor Client
node DNS

DNS <- Client: DNS lookup
DNS ..> Client: IP Address (<b>34.90.28.85</b>)

folder "hivetown-external" {
    interface "Floating External IP (<b>34.90.28.85</b>)" as LBFloatingIP
    Client --> LBFloatingIP : http(s)

    frame "loadbalancer-eu-west4" <<10.255.0.0/22>> {
        interface "loadbalancer-1-nic0" <<10.255.0.2>> as LB1NIC0
        interface "loadbalancer-2-nic0" <<10.255.0.2>> as LB2NIC0
    }

    ' Floating IP to interface
    LBFloatingIP --> LB1NIC0 : http(s)
    LBFloatingIP ..> LB2NIC0
}

frame "Load Balancers" as LB {
    ' Load balancer 1 (original active)
    node "loadbalancer-1" as LB1 {
        frame DockerCompose as LB1DockerCompose {
            component HaProxy as LB1HaProxy
            component ServiceDiscoverySync as LB1ServiceDiscoverySync
            LB1ServiceDiscoverySync -(0 LB1HaProxy : DataPlaneAPI
        }

        component Keepalived as LB1Keepalived
    }
    

    ' Load balancer 2 (original standby/backup)
    node "loadbalancer-2" as LB2 {
        frame DockerCompose as LB2DockerCompose {
            component HaProxy as LB2HaProxy
            component ServiceDiscoverySync as LB2ServiceDiscoverySync
            LB2ServiceDiscoverySync -(0 LB2HaProxy : DataPlaneAPI
        }

        component Keepalived as LB2Keepalived

        ' Keepalived on the left
        LB2Keepalived -[hidden] LB2DockerCompose
    }
}

folder "hivetown-internal" {
    frame "loadbalancers-eu-west4" <<10.0.0.0/22>> {
        interface "loadbalancer-1-nic1" <<10.0.0.2>> as LB1NIC1
        interface "loadbalancer-2-nic1" <<10.0.0.3>> as LB2NIC1

        ' HaProxy to external interface
        LB1NIC0 -[#blue]-> LB1HaProxy : http(s)
        LB2NIC0 -[#blue]-> LB2HaProxy : http(s)

        ' Keepalived VRRP
        LB1Keepalived -[#green]-> LB1NIC1
        LB2Keepalived -[#green]-> LB2NIC1
        LB1NIC1 <-[#green]> LB2NIC1 : vrrp

        ' Keepalived takeover
        LB1NIC0 <-[#green]- LB1Keepalived : takeover
        LB2NIC0 <-[#green]- LB2Keepalived : takeover

        ' HaProxy to internal interface
        LB1HaProxy -[#blue]-> LB1NIC1 : http
        LB2HaProxy -[#blue]-> LB2NIC1 : http

    }
}
