@startuml "System Architecture"

actor Client

node DNS

DNS <- Client : DNS lookup
DNS .> Client : IP address

frame Infrastructure {

    frame "Load Balancing" as LB {
        interface "Floating IP" as LBFloatingIP
        Client --> LBFloatingIP : http(s)

        node "Active LB" as ActiveLB {
            component HAProxy as ALBHAProxy
            component Keepalived as ALBKeepalived
            ALBHAProxy -[hidden] ALBKeepalived
        }
        LBFloatingIP -> ALBHAProxy

        node "Passive LB" as PassiveLB {
            component HAProxy as PLBHAProxy
            component Keepalived as PLBKeepalived
            PLBKeepalived -[hidden] PLBHAProxy

            ALBKeepalived -> PLBKeepalived : VRRP
            PLBKeepalived -> ALBKeepalived : VRRP
        }
        LBFloatingIP ...> PLBHAProxy
        ActiveLB -[hidden] PassiveLB


        interface "Internal" as LBInternal

        ALBHAProxy --> LBInternal : http(s)
        PLBHAProxy ..> LBInternal : http(s)

        note bottom of PassiveLB
            <b>Active-Passive</b>
            ---
            PassiveLB will take over if ActiveLB fails
            healthcheck by keepalived through VRRP

            On takeover, PassiveLB will become ActiveLB,
            exchanging the floating IP address
            ___
            Having more than one Passive LB makes
            the system more resilient. TODO?
        end note
    }

    ' frame "Service Discovery" as SD {
    '     node "Leader" as SDLeader {
    '     }

    '     node "Follower 1" as SDFollower1 {
    '     }

    '     node "Follower 2" as SDFollower2 {
    '     }

    '     SDFollower1 -> SDLeader : Replication
    '     SDFollower1 <. SDLeader : TCP/8300
    '     SDLeader <- SDFollower2 : Replication
    '     SDLeader .> SDFollower2 : TCP/8300
    ' }

    ' LB -[hidden]- SD

    frame "Web Servers" as WS {
        node "Web Server 1" as WS1 {
            component "Frontend" as WS1Frontend
            component "REST API" as WS1RestAPI
        }
        node "Web Server 2" as WS2 {
            component "Frontend" as WS2Frontend
            component "REST API" as WS2RestAPI
        }

        interface "Database" as WSDatabase
        WS1RestAPI --> WSDatabase : http(s)
        WS2RestAPI --> WSDatabase: http(s)

        interface "External Services" as WSExternal
        WS1 --> WSExternal : http(s)
        WS2 --> WSExternal : http(s)

        WSDatabase -[hidden] WSExternal

        note as WSNote
            <b>Web Servers</b>
            ---
            More servers can be added
            to increase the capacity
        end note

        WS1 -[hidden] WSNote
        WS2 -[hidden] WSNote
    }

    LBInternal --> WS1 : http(s)
    LBInternal --> WS2 : http(s)

    frame "Database" as DB {
        node "Slave 1" as DBSlave1 {
            component mysqld as DBSlave1Mysqld
        }
        node "Master" as DBMaster {
            component mysqld as DBMasterMysqld
        }
        node "Slave 2" as DBSlave2 {
            component mysqld as DBSlave2Mysqld
        }

        DBSlave1Mysqld <- DBMasterMysqld : Replication
        DBMasterMysqld -> DBSlave2Mysqld : Replication

        node "Backup 1" as DBBackup1 {
            component mysqldump as DBBackup1Mysqldump
            component cron as DBBackup1Cron
        }
        node "Backup 2" as DBBackup2 {
            component mysqldump as DBBackup2Mysqldump
            component cron as DBBackup2Cron
        }

        DBSlave1Mysqld --> DBBackup1 : Backup
        DBSlave2Mysqld --> DBBackup2 : Backup

        note as DBNote
            <b>Master Slave replication</b>
            ---
            MySQL Replication
        end note

        DBMasterMysqld .. DBNote
        DBSlave1Mysqld .. DBNote
        DBSlave2Mysqld .. DBNote
    }

    WSDatabase <--> DBMasterMysqld : reads/writes
    WSDatabase <-- DBSlave1Mysqld : reads
    WSDatabase <-- DBSlave2Mysqld : reads
}

frame External {
    interface Inbound as EXInbound
    node FirebaseAuth
    node StaticContent
    node Stripe

    FirebaseAuth -[hidden]- StaticContent
    StaticContent -[hidden]- Stripe

    EXInbound -> FirebaseAuth : http(s)
    EXInbound -> StaticContent : http(s)
    EXInbound -> Stripe : http(s)
}

WSExternal -> EXInbound : http(s)

@enduml